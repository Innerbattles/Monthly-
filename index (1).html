<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üåø Endless 3D Monthly Competition</title>

  <!-- =====================
       Minimal, clean styling
       ===================== -->
  <style>
    :root {
      --bg: #ddecd5;
      --text: #2c2c2c;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    header {
      text-align: center;
      padding-top: 18px;
    }

    h1 {
      margin: 0;
      font-weight: 800;
      font-size: 2rem;
      letter-spacing: 0.2px;
    }

    #week-label {
      margin-top: 4px;
      font-size: 0.95rem;
      color: #6b6b6b;
    }

    /* 3D canvas area */
    #magic-beam {
      display: block;
      width: 100%;
      height: 320px;       /* initial height; we also manage on resize via JS */
      margin: 14px 0 6px 0;
    }

    .bar-labels {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      width: min(1200px, 90vw);
      margin: 0 auto;
      font-weight: 700;
      font-size: 1.08rem;
    }

    .stat-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.7);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid rgba(0,0,0,0.05);
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
    }
    .dot.green { background: #00c97a; }
    .dot.orange{ background: #ff8800; }

    footer {
      text-align: center;
      color: #666;
      font-size: 0.9rem;
      padding: 16px 0 22px 0;
    }

    /* Small helper note area (optional) */
    #note {
      width: min(1200px, 90vw);
      margin: 8px auto 0 auto;
      color: #7a7a7a;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>üåø Monthly Competition</h1>
    <div id="week-label">Loading week‚Ä¶</div>
  </header>

  <!-- 3D animated "battle beam" -->
  <canvas id="magic-beam"></canvas>

  <!-- Live stats under the beam -->
  <div class="bar-labels">
    <span id="rugrats-label" class="stat-chip"><i class="dot green"></i>Rugrats: 0% (0)</span>
    <span id="filekeepers-label" class="stat-chip"><i class="dot orange"></i>Filekeepers: 0% (0)</span>
  </div>

  <div id="note"></div>

  <footer>Endless Marketing Services ‚Äî 3D Magical Dashboard ‚ö°</footer>

  <!-- =============
       Three.js setup
       ============= -->
  <script type="module">
    /* Import modern Three.js + helpers from CDN (Vercel supports modules) */
    import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.module.js";
    import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.159.0/examples/jsm/controls/OrbitControls.js";
    import { UnrealBloomPass } from "https://cdn.jsdelivr.net/npm/three@0.159.0/examples/jsm/postprocessing/UnrealBloomPass.js";
    import { EffectComposer } from "https://cdn.jsdelivr.net/npm/three@0.159.0/examples/jsm/postprocessing/EffectComposer.js";
    import { RenderPass } from "https://cdn.jsdelivr.net/npm/three@0.159.0/examples/jsm/postprocessing/RenderPass.js";
    import gsap from "https://cdn.jsdelivr.net/npm/gsap@3.12.5/index.js";

    /* =====================
       Google Sheets settings
       ===================== */
    // Provided by the user
    const SHEET_ID  = "1pkNqNi_k5Ez1L1cYuvsT64m4oduGPJ4R7nLxesw6nrE";
    const API_KEY   = "AIzaSyB0TtVnOafgkbRwCaqkSxPogGLUgyWqZaE";

    // We auto-pick sheet tab by current ISO week: W{week}
    function computeWeekTab() {
      const now = new Date();
      const start = new Date(now.getFullYear(), 0, 1);
      const days = Math.floor((now - start) / (24 * 60 * 60 * 1000));
      const week = Math.ceil((days + start.getDay() + 1) / 7);
      return "W" + week;
    }

    // If your weekly tab differs, change this to a fixed string, e.g. "W45"
    let DATA_SHEET = computeWeekTab();   // e.g. "W45", "W46", ...
    const RANGE     = "S3:T3";          // S = CR PULL (fk), T = XFER (rug)

    // Write week label at top
    (function paintWeekLabel(){
      const now  = new Date();
      const start= new Date(now.getFullYear(), 0, 1);
      const days = Math.floor((now - start) / (24*60*60*1000));
      const week = Math.ceil((days + start.getDay() + 1) / 7);
      document.getElementById("week-label").textContent = "üìÖ Week " + week + " ‚Äî Tab: " + DATA_SHEET;
    })();

    // Optional helper: surface notes to the user
    function setNote(msg){
      document.getElementById("note").textContent = msg || "";
    }

    /* ==================
       Three.js 3D scene
       ================== */
    const canvas = document.getElementById("magic-beam");
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    const scene    = new THREE.Scene();
    const camera   = new THREE.PerspectiveCamera(60, 16/9, 0.1, 100);

    // Initial sizes
    function sizeRenderer() {
      const w = window.innerWidth;
      const h = Math.max(240, Math.min(420, Math.round(window.innerHeight * 0.35)));
      renderer.setSize(w, h, false);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
    }
    sizeRenderer();
    window.addEventListener("resize", sizeRenderer);

    scene.background = new THREE.Color("#ddecd5");
    camera.position.set(0, 0, 4);

    // Controls disabled (we keep to false for a clean banner look)
    const controls = new OrbitControls(camera, canvas);
    controls.enableZoom = false;
    controls.enablePan  = false;
    controls.enableRotate = false;

    // Lights
    const ambient = new THREE.AmbientLight(0xffffff, 0.65);
    scene.add(ambient);

    const lightL = new THREE.PointLight(0x00ff88, 1.8, 10);
    lightL.position.set(-1.5, 0, 1);
    scene.add(lightL);

    const lightR = new THREE.PointLight(0xff6600, 1.8, 10);
    lightR.position.set( 1.5, 0, 1);
    scene.add(lightR);

    // Beams: two cylinders lying horizontally
    const beamGeo = new THREE.CylinderGeometry(0.06, 0.06, 2.2, 40);
    const greenMat  = new THREE.MeshStandardMaterial({ emissive: 0x00ff88, emissiveIntensity: 2.1, color: 0x20ff98, roughness: 0.2, metalness: 0.1 });
    const orangeMat = new THREE.MeshStandardMaterial({ emissive: 0xff6600, emissiveIntensity: 2.1, color: 0xffa000, roughness: 0.2, metalness: 0.1 });

    const beamLeft = new THREE.Mesh(beamGeo, greenMat);
    beamLeft.rotation.z = Math.PI / 2;
    beamLeft.position.x = -1.1;
    scene.add(beamLeft);

    const beamRight = new THREE.Mesh(beamGeo, orangeMat);
    beamRight.rotation.z = Math.PI / 2;
    beamRight.position.x =  1.1;
    scene.add(beamRight);

    // Collision core (glowing sphere)
    const collisionGeo = new THREE.SphereGeometry(0.18, 40, 40);
    const collisionMat = new THREE.MeshBasicMaterial({ color: 0xffff99 });
    const collision    = new THREE.Mesh(collisionGeo, collisionMat);
    collision.position.z = 0.02;
    scene.add(collision);

    // Nice post-processing bloom
    const composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));
    const bloom = new UnrealBloomPass(new THREE.Vector2(1920, 1080), 1.35, 0.42, 0.85);
    composer.addPass(bloom);

    // Continuous animation
    function animate() {
      requestAnimationFrame(animate);
      // Subtle breathing effect on collision core
      collision.scale.setScalar(1 + 0.22 * Math.sin(Date.now() * 0.0045));
      composer.render();
    }
    animate();

    /* =====================
       Beam update by values
       ===================== */
    function updateBeam(rugValue, fkValue) {
      const total = rugValue + fkValue || 1;
      const rugPercent = (rugValue / total) * 100;

      // Move collision point relative to advantage [-1..1] -> map to beam positions
      const beamShift = (rugPercent - 50) / 50; // -1 (FK lead) .. +1 (Rug lead)
      const offset = beamShift * 0.85;

      // Scale beams in opposition
      beamLeft.scale.set(1 + offset, 1, 1);
      beamRight.scale.set(1 - offset, 1, 1);
      collision.position.x = offset * 1.6;

      // Lights respond to advantage
      lightL.intensity = 1.6 + 0.6 * Math.max(0,  offset);
      lightR.intensity = 1.6 + 0.6 * Math.max(0, -offset);

      // Color warmth on the core
      gsap.to(collision.material.color, {
        r: rugPercent > 50 ? 0.55 : 1.00,
        g: rugPercent > 50 ? 1.00 : 0.40,
        b: 0.32,
        duration: 0.9,
        ease: "sine.inOut"
      });

      // Update labels
      const rugLbl = document.getElementById("rugrats-label");
      const fkLbl  = document.getElementById("filekeepers-label");
      rugLbl.textContent = `Rugrats: ${rugPercent.toFixed(1)}% (${rugValue})`;
      fkLbl.textContent  = `Filekeepers: ${(100 - rugPercent).toFixed(1)}% (${fkValue})`;
      // Re-add dots
      rugLbl.prepend(Object.assign(document.createElement("i"), {className: "dot green"}));
      fkLbl.prepend(Object.assign(document.createElement("i"), {className: "dot orange"}));
    }

    /* ===========================
       Google Sheets data fetching
       =========================== */
    async function fetchSheetRange(sheetName, rangeA1) {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(sheetName)}!${rangeA1}?key=${API_KEY}`;
      const res = await fetch(url);
      if (!res.ok) {
        // Bubble error so we can fallback
        const text = await res.text();
        throw new Error("Sheets API error " + res.status + ": " + text);
      }
      return res.json();
    }

    async function loadDataWithFallback() {
      // Try WEEK tab first (e.g., W45/W46); if not found, fallback to "W45"
      try {
        const j = await fetchSheetRange(DATA_SHEET, RANGE);
        const row = j.values?.[0] || [0,0];
        const fkValue  = Number(row[0]) || 0; // Col S (CR PULL) -> Filekeepers
        const rugValue = Number(row[1]) || 0; // Col T (XFER)    -> Rugrats
        updateBeam(rugValue, fkValue);
        setNote(`Live from ${DATA_SHEET}! Range ${RANGE}`);
      } catch (e1) {
        console.warn("Primary tab failed:", e1?.message || e1);
        try {
          const fallbackTab = "W45";
          const j2 = await fetchSheetRange(fallbackTab, RANGE);
          const row2 = j2.values?.[0] || [0,0];
          const fk2  = Number(row2[0]) || 0;
          const rr2  = Number(row2[1]) || 0;
          updateBeam(rr2, fk2);
          setNote(`Fallback to ${fallbackTab} (range ${RANGE}). Check your current-week tab exists.`);
        } catch (e2) {
          console.error("Fallback also failed:", e2?.message || e2);
          updateBeam(50, 50); // neutral demo
          setNote("‚ö†Ô∏è Could not load Google Sheets data. Ensure the sheet is accessible with your API key or set it to Anyone with the link (Viewer).");
        }
      }
    }

    // Initial load + periodic refresh
    loadDataWithFallback();
    // Refresh every 60s
    setInterval(loadDataWithFallback, 60_000);
  </script>
</body>
</html>
